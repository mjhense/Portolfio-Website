@page "/portfolio/{Id}"

@inherits MainLayout
@inject IJSRuntime JS
@inject PortfolioService PortfolioService
@inject NavigationManager Navigation

<PageTitle>@Piece?.Title</PageTitle>

@if (Piece == null)
{
    <div class="container">
        <h2>Project not found</h2>
    </div>
}
else
{
    <!-- HERO -->
    <section class="project-hero">
        <img src="@Piece.Images[0]" />
    </section>

    <!-- TITLE BAR -->
    <section class="project-header container">
        <div class="project-title-area">
            <h1>@Piece.Title</h1>
            <div class="project-meta">
                <span>@Piece.Category</span>
                <span>•</span>
                <span>Michael Hense</span>
            </div>
        </div>
    </section>

    <!-- MAIN CONTENT -->
    <section class="project-body container">

        <!-- LEFT: GALLERY -->
        <div class="project-gallery">
            @for (int i = 0; i < Piece.Images.Count; i++)
            {
                var index = i;

                <img src="@Piece.Images[index]"
                     @onclick="() => OpenViewer(index)" />
            }
        </div>

        <!-- RIGHT: SIDEBAR -->
        <aside class="project-sidebar">

            <div class="sidebar-section">
                <h3>Project Info</h3>

                <div class="info-row">
                    <span class="label">Artist</span>
                    <span>Michael Hense</span>
                </div>

                <div class="info-row">
                    <span class="label">Category</span>
                    <span>@Piece.Category</span>
                </div>

                <div class="info-row">
                    <span class="label">Software</span>
                    <span>Blender, Substance Painter, ZBrush</span>
                </div>
            </div>


            <!-- DESCRIPTION -->
            <section class="project-description container">

                <h2>Description</h2>

                <p>
                    @Piece.Description
                </p>

            </section>
        </aside>

    </section>

    @if (isViewerVisible)
    {
        <div class="viewer-overlay @(IsViewerOpen ? "open" : "closing")"
             tabindex="0"
             @onkeydown="HandleKeyDown"
             @onclick="HandleOverlayClick"
             @ref="viewerElement">

            <div class="viewer-content" @onclick:stopPropagation="true">

                <button class="viewer-close" @onclick="CloseViewer">✕</button>

                <button class="viewer-nav left" @onclick="PrevImage">‹</button>

                <img src="@Piece.Images[CurrentImageIndex]"
                     class="viewer-image @(IsViewerOpen ? "open" : "closing")" />

                <button class="viewer-nav right" @onclick="NextImage">›</button>

            </div>
        </div>
    }
}

@code {

    [Parameter]
    public required string ID { get; set; }
    [Parameter]
    public required PortfolioPiece Piece { get; set; }

    bool IsViewerOpen = false;
    bool isViewerVisible = false;
    int CurrentImageIndex = 0;
    ElementReference viewerElement;

    protected override void OnInitialized()
    {
        Piece = PortfolioService.GetHighlightPieceById(ID);
        if (Piece.Images.Count == 0 && !string.IsNullOrEmpty(Piece.Image))
        {
            Piece.Images.Add(Piece.Image);
        }
    }

    async Task OpenViewer(int index)
    {
        CurrentImageIndex = index;

        isViewerVisible = true;
        StateHasChanged();

        await Task.Delay(10);

        IsViewerOpen = true;

        await viewerElement.FocusAsync();
    }

    async Task CloseViewer()
    {
        IsViewerOpen = false;

        await Task.Delay(250); // match CSS animation time

        isViewerVisible = false;
    }

    void HandleOverlayClick()
    {
        _ = CloseViewer();
    }

    void NextImage()
    {
        if (Piece?.Images == null || Piece.Images.Count == 0)
            return;

        CurrentImageIndex = (CurrentImageIndex + 1) % Piece.Images.Count;
    }

    void PrevImage()
    {
        if (Piece?.Images == null || Piece.Images.Count == 0)
            return;

        CurrentImageIndex--;

        if (CurrentImageIndex < 0)
            CurrentImageIndex = Piece.Images.Count - 1;
    }

    void GoBack()
    {
        Navigation.NavigateTo("/home");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsViewerOpen)
        {
            await viewerElement.FocusAsync();
        }
    }

    void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            _ = CloseViewer();
        }

        if (e.Key == "ArrowRight")
        {
            NextImage();
        }

        if (e.Key == "ArrowLeft")
        {
            PrevImage();
        }
    }
}